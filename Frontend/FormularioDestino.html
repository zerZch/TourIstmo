<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Destino Turístico</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/formulario.css">
</head>
<body>
<body>
<body>
    <div class="main-container">
        <!-- Left Panel -->
        <div class="left-panel">
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="logo-text">TOURISTMO</div>
                </div>

                <div class="progress-section">
                    <h2 class="progress-title" id="progressTitle">¡Comparte tu destino favorito con el mundo!</h2>
                    
                    <div class="progress-steps">
                        <div class="step active" data-step="1">
                            <div class="step-indicator">1</div>
                            <div class="step-text">Información básica</div>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-indicator">2</div>
                            <div class="step-text">Detalles y fotos</div>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-indicator">3</div>
                            <div class="step-text">Ubicación y precios</div>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-indicator">4</div>
                            <div class="step-text">Confirmar</div>
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
            
            <div class="destination-preview">
                <div class="preview-text" id="previewText">
                    Tu destino se unirá a nuestra colección de lugares increíbles de Panamá
                </div>
                <div class="destination-info" id="destinationInfo">
                    <div class="destination-name" id="destinationName">Nombre del destino</div>
                    <div class="destination-details" id="destinationDetails">
                        Completa el formulario para ver los detalles
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel -->
        <div class="right-panel">
            <div class="form-header">
                <h1 class="form-title" id="formTitle">Información Básica</h1>
                <p class="form-subtitle" id="formSubtitle">Comencemos con los datos básicos de tu destino turístico.</p>
            </div>
            
            <div id="successMessage" class="success-message">
                ¡Destino registrado exitosamente!
            </div>
            
            <form id="destinoForm" action="/TourIstmo/BACKEND/formulario-destino.jsp" method="post" enctype="multipart/form-data">
                <!-- Sección 1: Información básica -->
                <div class="form-section active" data-section="1">
                    <div class="form-group">
                        <label class="form-label" for="nombre">Nombre del lugar</label>
                        <input type="text" name="Nombre" id="nombre" class="form-input" required 
                               placeholder="Ej: Playa Blanca, Volcán Barú, Casco Viejo..." />
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="provincia">Provincia</label>
                            <select name="ID_Provincia" id="provincia" class="form-select" required>
                                <option value="">Selecciona una provincia</option>
                                <option value="1">Bocas del Toro</option>
                                <option value="2">Coclé</option>
                                <option value="3">Colón</option>
                                <option value="4">Chiriquí</option>
                                <option value="5">Darién</option>
                                <option value="6">Herrera</option>
                                <option value="7">Los Santos</option>
                                <option value="8">Panamá</option>
                                <option value="9">Panamá Oeste</option>
                                <option value="10">Veraguas</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="distrito">Distrito</label>
                            <select name="ID_Distrito" id="distrito" class="form-select" required>
                                <option value="">Primero selecciona provincia</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="tipo">Tipo de destino</label>
                        <select name="Tipo" id="tipo" class="form-select" required>
                            <option value="">Selecciona el tipo</option>
                            <option value="Playa">Playa</option>
                            <option value="Montaña">Montaña</option>
                            <option value="Sitio histórico">Sitio histórico</option>
                            <option value="Parque Nacional">Parque Nacional</option>
                            <option value="Ciudad">Ciudad</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>
                
                <!-- Sección 2: Detalles del lugar y fotos -->
                <div class="form-section" data-section="2">
                    <div class="form-group">
                        <label class="form-label" for="descripcion">Descripción</label>
                        <textarea name="Descripcion" id="descripcion" class="form-textarea" required rows="4"
                                  placeholder="Cuéntanos qué hace especial a este lugar. ¿Qué pueden esperar los visitantes?"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="horario">Horario de funcionamiento</label>
                            <input type="text" name="Horario" id="horario" class="form-input" 
                                   placeholder="Ej: 8:00 AM - 5:00 PM" />
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="estado">Estado actual</label>
                            <input type="text" name="Descripcion_EST" id="estado" class="form-input" 
                                   placeholder="Ej: Excelente, En renovación..." />
                        </div>
                    </div>

                    <!-- Sección de imagen -->
                    <div class="form-group">
                        <label class="form-label">Imagen Principal del Destino</label>
                        <div class="image-upload-container" id="imageUploadContainer">
                            <div class="image-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="image-upload-text">Arrastra y suelta tu imagen aquí</div>
                            <div class="image-upload-subtext">o haz clic para seleccionar un archivo (máximo 5MB)</div>
                            <input type="file" name="imagen" id="imagen" accept="image/*" style="display: none;" />
                        </div>
                        <div id="imagePreviewContainer" style="display: none;">
                            <img id="imagePreview" class="image-preview" alt="Vista previa de la imagen" />
                            <div class="image-info">
                                <span id="imageInfo">Archivo seleccionado</span>
                                <button type="button" class="remove-image" onclick="removeImage()">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección 3: Ubicación y precios -->
                <div class="form-section" data-section="3">
                    <div class="form-group">
                        <label class="form-label" for="mapa">URL del mapa (Google Maps)</label>
                        <input type="url" name="Ubicacion_Mapa_URL" id="mapa" class="form-input" required
                               placeholder="https://maps.google.com/..." />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="precio">Precio entrada (USD)</label>
                        <input type="number" name="Precio_Entrada" id="precio" class="form-input" 
                               min="0" step="0.01" placeholder="0.00" />
                    </div>
                </div>
                
                <!-- Sección 4: Confirmación -->
                <div class="form-section" data-section="4">
                    <div class="form-group">
                        <h3 style="color: var(--primary-dark); margin-bottom: 20px;">Resumen del destino</h3>
                        <div id="summaryContent" style="background: #F9FAFB; padding: 20px; border-radius: 16px; border: 2px solid #E5E7EB;">
                            <p>Completa las secciones anteriores para ver el resumen.</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="prevBtn" disabled>
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        Siguiente <i class="fas fa-arrow-right"></i>
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>

    let currentStep = 1;
    const totalSteps = 4;
    let selectedPhotos = [];
    const maxPhotos = 10;

    const distritosPorProvincia = {
        "1": [
            { "id": 1, "nombre": "Bocas del Toro" },
            { "id": 2, "nombre": "Changuinola" },
            { "id": 3, "nombre": "Chiriquí Grande" }
        ],
        "2": [
            { "id": 4, "nombre": "Aguadulce" },
            { "id": 5, "nombre": "Antón" },
            { "id": 6, "nombre": "La Pintada" },
            { "id": 7, "nombre": "Natá" },
            { "id": 8, "nombre": "Olá" },
            { "id": 9, "nombre": "Penonomé" }
        ],
        "3": [
            { "id": 10, "nombre": "Colón" },
            { "id": 11, "nombre": "Chagres" },
            { "id": 12, "nombre": "Donoso" },
            { "id": 13, "nombre": "Portobelo" },
            { "id": 14, "nombre": "Santa Isabel" }
        ],
        "4": [
            { "id": 15, "nombre": "Alanje" },
            { "id": 16, "nombre": "Barú" },
            { "id": 17, "nombre": "Boquerón" },
            { "id": 18, "nombre": "Boquete" },
            { "id": 19, "nombre": "Bugaba" },
            { "id": 20, "nombre": "David" },
            { "id": 21, "nombre": "Dolega" },
            { "id": 22, "nombre": "Gualaca" },
            { "id": 23, "nombre": "Remedios" },
            { "id": 24, "nombre": "Renacimiento" },
            { "id": 25, "nombre": "San Félix" },
            { "id": 26, "nombre": "San Lorenzo" },
            { "id": 27, "nombre": "Tierras Altas" },
            { "id": 28, "nombre": "Tolé" }
        ],
        "5": [
            { "id": 29, "nombre": "Chepigana" },
            { "id": 30, "nombre": "Pinogana" }
        ],
        "6": [
            { "id": 31, "nombre": "Chitré" },
            { "id": 32, "nombre": "Las Minas" },
            { "id": 33, "nombre": "Los Pozos" },
            { "id": 34, "nombre": "Ocú" },
            { "id": 35, "nombre": "Parita" },
            { "id": 36, "nombre": "Pesé" },
            { "id": 37, "nombre": "Santa María" }
        ],
        "7": [
            { "id": 38, "nombre": "Guararé" },
            { "id": 39, "nombre": "Las Tablas" },
            { "id": 40, "nombre": "Los Santos" },
            { "id": 41, "nombre": "Macaracas" },
            { "id": 42, "nombre": "Pedasí" },
            { "id": 43, "nombre": "Pocrí" },
            { "id": 44, "nombre": "Tonosí" }
        ],
        "8": [
            { "id": 45, "nombre": "Balboa" },
            { "id": 46, "nombre": "Chepo" },
            { "id": 47, "nombre": "Chimán" },
            { "id": 48, "nombre": "Panamá" },
            { "id": 49, "nombre": "San Miguelito" },
            { "id": 50, "nombre": "Taboga" }
        ],
        "9": [
            { "id": 51, "nombre": "Atalaya" },
            { "id": 52, "nombre": "Calobre" },
            { "id": 53, "nombre": "Cañazas" },
            { "id": 54, "nombre": "La Mesa" },
            { "id": 55, "nombre": "Las Palmas" },
            { "id": 56, "nombre": "Montijo" },
            { "id": 57, "nombre": "Río de Jesús" },
            { "id": 58, "nombre": "San Francisco" },
            { "id": 59, "nombre": "Santa Fé" },
            { "id": 60, "nombre": "Santiago" },
            { "id": 61, "nombre": "Soná" },
            { "id": 62, "nombre": "Mariato" }
        ],
        "10": [
            { "id": 63, "nombre": "Arraiján" },
            { "id": 64, "nombre": "Capira" },
            { "id": 65, "nombre": "Chame" },
            { "id": 66, "nombre": "La Chorrera" },
            { "id": 67, "nombre": "San Carlos" }
        ],
        "11": [
            { "id": 68, "nombre": "Kuna Yala" },
            { "id": 69, "nombre": "Kuna de Madugandí" },
            { "id": 70, "nombre": "Kuna de Wargandí" }
        ],
        "12": [
            { "id": 71, "nombre": "Cémaco" },
            { "id": 72, "nombre": "Sambú" }
        ],
        "13": [
            { "id": 73, "nombre": "Besiko" },
            { "id": 74, "nombre": "Jirondai" },
            { "id": 75, "nombre": "Kankintú" },
            { "id": 76, "nombre": "Kusapín" },
            { "id": 77, "nombre": "Mironó" },
            { "id": 78, "nombre": "Müna" },
            { "id": 79, "nombre": "Nole Duima" },
            { "id": 80, "nombre": "Ñürüm" },
            { "id": 81, "nombre": "Santa Catalina o Calovébora" }
        ]
    };

    const stepContent = {
        1: { title: 'Información básica', subtitle: 'Comencemos con los datos básicos de tu destino turístico.' },
        2: { title: 'Detalles y fotos', subtitle: 'Cuéntanos más sobre tu destino y sube imágenes.' },
        3: { title: 'Ubicación y precios', subtitle: 'Información sobre ubicación y costos.' },
        4: { title: 'Confirmar', subtitle: 'Revisa y confirma todos los datos antes de enviar.' }
    };

    // Configuración para imágenes
    const IMAGE_CONFIG = {
        maxWidth: 1200,
        maxHeight: 800,
        quality: 0.8,
        maxFileSize: 2 * 1024 * 1024, // 2MB después de compresión
        allowedTypes: ['image/jpeg', 'image/png', 'image/webp']
    };

    // --- Inicialización al cargar la página ---
    document.addEventListener('DOMContentLoaded', function() {
        updateStepDisplay();
        initializeImageUpload();
        setupFormValidation();
        setupEventListeners();
    });

    // Configurar validación de formulario
    function setupFormValidation() {
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('blur', function() {
                validateField(this);
            });
            
            element.addEventListener('input', function() {
                if (this.classList.contains('field-validation')) {
                    validateField(this);
                }
                updatePreview();
            });
        });
    }

    // Validar un campo individual
    function validateField(field) {
        if (field.hasAttribute('required') && !field.value.trim()) {
            field.classList.add('field-validation');
            field.classList.remove('field-valid');
            return false;
        } else if (field.value.trim()) {
            field.classList.remove('field-validation');
            field.classList.add('field-valid');
            return true;
        } else {
            field.classList.remove('field-validation', 'field-valid');
            return true;
        }
    }

    // Configurar event listeners
    function setupEventListeners() {
        // Botones de navegación
        document.getElementById('nextBtn').addEventListener('click', nextStep);
        document.getElementById('prevBtn').addEventListener('click', previousStep);
        
        // Formulario
        document.getElementById('destinoForm').addEventListener('submit', handleSubmit);
        
        // Provincia/Distrito
        document.getElementById("provincia").addEventListener("change", function() {
            updateDistricts(this.value);
            updatePreview();
        });
        
        document.getElementById("distrito").addEventListener("change", updatePreview);
        
        // Campos que afectan el preview
        ['nombre', 'tipo'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updatePreview);
            }
        });
    }

    // Inicializar funcionalidad de imagen
    function initializeImageUpload() {
        const container = document.getElementById('imageUploadContainer');
        const input = document.getElementById('imagen');
        const previewContainer = document.getElementById('imagePreviewContainer');
        const preview = document.getElementById('imagePreview');
        const info = document.getElementById('imageInfo');

        if (!container || !input) return;

        // Click para abrir selector de archivos
        container.addEventListener('click', () => {
            input.click();
        });

        // Drag and drop
        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            container.classList.add('dragover');
        });

        container.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (!container.contains(e.relatedTarget)) {
                container.classList.remove('dragover');
            }
        });

        container.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            container.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFile(files[0]);
            }
        });

        // Cambio en input file
        input.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });
    }

    // Manejar archivo de imagen
    function handleImageFile(file) {
        // Validar tipo de archivo
        if (!IMAGE_CONFIG.allowedTypes.includes(file.type)) {
            showImageError('Por favor, selecciona una imagen válida (JPEG, PNG o WebP).');
            return;
        }

        // Mostrar loader
        showImageLoader();

        // Comprimir y procesar imagen
        compressImage(file)
            .then(compressedFile => {
                displayImage(compressedFile);
                updateFileInput(compressedFile);
            })
            .catch(error => {
                console.error('Error al procesar la imagen:', error);
                showImageError('Error al procesar la imagen. Por favor, intenta con otra imagen.');
            });
    }

    // Comprimir imagen
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                // Calcular nuevas dimensiones manteniendo aspect ratio
                let { width, height } = calculateDimensions(img.width, img.height);
                
                canvas.width = width;
                canvas.height = height;

                // Dibujar imagen redimensionada
                ctx.drawImage(img, 0, 0, width, height);

                // Convertir a blob con compresión
                canvas.toBlob((blob) => {
                    if (blob) {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });

                        // Verificar tamaño final
                        if (compressedFile.size > IMAGE_CONFIG.maxFileSize) {
                            // Comprimir más si es necesario
                            canvas.toBlob((smallerBlob) => {
                                if (smallerBlob) {
                                    const smallerFile = new File([smallerBlob], file.name, {
                                        type: 'image/jpeg',
                                        lastModified: Date.now()
                                    });
                                    resolve(smallerFile);
                                } else {
                                    reject(new Error('Error al comprimir la imagen'));
                                }
                            }, 'image/jpeg', 0.6);
                        } else {
                            resolve(compressedFile);
                        }
                    } else {
                        reject(new Error('Error al convertir la imagen'));
                    }
                }, 'image/jpeg', IMAGE_CONFIG.quality);
            };

            img.onerror = () => reject(new Error('Error al cargar la imagen'));
            img.src = URL.createObjectURL(file);
        });
    }

    // Calcular dimensiones
    function calculateDimensions(originalWidth, originalHeight) {
        let width = originalWidth;
        let height = originalHeight;

        // Redimensionar si excede los límites
        if (width > IMAGE_CONFIG.maxWidth) {
            height = (height * IMAGE_CONFIG.maxWidth) / width;
            width = IMAGE_CONFIG.maxWidth;
        }

        if (height > IMAGE_CONFIG.maxHeight) {
            width = (width * IMAGE_CONFIG.maxHeight) / height;
            height = IMAGE_CONFIG.maxHeight;
        }

        return { width: Math.round(width), height: Math.round(height) };
    }

    // Mostrar imagen
    function displayImage(file) {
        const container = document.getElementById('imageUploadContainer');
        const previewContainer = document.getElementById('imagePreviewContainer');
        const preview = document.getElementById('imagePreview');
        const info = document.getElementById('imageInfo');

        const reader = new FileReader();
        reader.onload = (e) => {
            if (preview) {
                preview.src = e.target.result;
                preview.style.objectFit = 'cover';
                preview.style.width = '100%';
                preview.style.height = '200px';
                preview.style.borderRadius = '10px';
            }
            
            if (info) {
                info.innerHTML = `
                    <div style="color: #10b981; font-size: 0.9em;">
                        <i class="fas fa-check-circle"></i>
                        ${file.name}
                    </div>
                    <div style="color: #6b7280; font-size: 0.8em;">
                        ${(file.size / 1024 / 1024).toFixed(2)} MB
                    </div>
                `;
            }
            
            hideImageLoader();
            if (container) container.style.display = 'none';
            if (previewContainer) previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // Actualizar input de archivo
    function updateFileInput(file) {
        const input = document.getElementById('imagen');
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        input.files = dataTransfer.files;
    }

    // Eliminar imagen
    function removeImage() {
        const container = document.getElementById('imageUploadContainer');
        const previewContainer = document.getElementById('imagePreviewContainer');
        const input = document.getElementById('imagen');
        
        if (container) container.style.display = 'block';
        if (previewContainer) previewContainer.style.display = 'none';
        if (input) input.value = '';
    }

    // Mostrar loader de imagen
    function showImageLoader() {
        const info = document.getElementById('imageInfo');
        if (info) {
            info.innerHTML = `
                <div style="color: #3b82f6; font-size: 0.9em;">
                    <i class="fas fa-spinner fa-spin"></i>
                    Procesando imagen...
                </div>
            `;
        }
    }

    // Ocultar loader de imagen
    function hideImageLoader() {
        // El loader se oculta cuando se muestra la imagen
    }

    // Mostrar error de imagen
    function showImageError(message) {
        const info = document.getElementById('imageInfo');
        if (info) {
            info.innerHTML = `
                <div style="color: #ef4444; font-size: 0.9em;">
                    <i class="fas fa-exclamation-circle"></i>
                    ${message}
                </div>
            `;
        }
        
        setTimeout(() => {
            if (info) info.innerHTML = '';
        }, 5000);
    }

    // Actualizar distritos según provincia
    function updateDistricts(provinciaId) {
        const distritoSelect = document.getElementById("distrito");
        distritoSelect.innerHTML = "<option value=''>Selecciona un distrito</option>";

        if (distritosPorProvincia[provinciaId]) {
            distritosPorProvincia[provinciaId].forEach(distrito => {
                const option = document.createElement("option");
                option.value = distrito.id;
                option.textContent = distrito.nombre;
                distritoSelect.appendChild(option);
            });
        }
    }

    // --- Navegación entre pasos ---
    function nextStep() {
        if (validateCurrentStep() && currentStep < totalSteps) {
            currentStep++;
            updateStepDisplay();
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepDisplay();
        }
    }

    // Validar paso actual
    function validateCurrentStep() {
        const currentSection = document.querySelector(`[data-section="${currentStep}"]`);
        if (!currentSection) return true;
        
        const requiredFields = currentSection.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!validateField(field)) {
                isValid = false;
            }
        });

        if (!isValid) {
            showErrorMessage('Por favor completa todos los campos obligatorios del paso actual.');
        }
        return isValid;
    }

    // Actualizar visualización del paso
    function updateStepDisplay() {
        // Actualizar barra de progreso
        const progressFill = document.getElementById('progressFill');
        if (progressFill) {
            progressFill.style.width = `${(currentStep / totalSteps) * 100}%`;
        }

        // Actualizar indicadores de pasos
        document.querySelectorAll('.step').forEach((step, index) => {
            const stepNumber = index + 1;
            step.classList.remove('active', 'completed');
            if (stepNumber === currentStep) {
                step.classList.add('active');
            } else if (stepNumber < currentStep) {
                step.classList.add('completed');
            }
        });

        // Mostrar/ocultar secciones
        document.querySelectorAll('.form-section').forEach((section, index) => {
            const sectionNumber = index + 1;
            section.classList.remove('active');
            if (sectionNumber === currentStep) {
                section.classList.add('active');
            }
        });

        // Actualizar título y subtítulo
        const formTitle = document.getElementById('formTitle');
        const formSubtitle = document.getElementById('formSubtitle');
        if (formTitle && stepContent[currentStep]) {
            formTitle.textContent = stepContent[currentStep].title;
        }
        if (formSubtitle && stepContent[currentStep]) {
            formSubtitle.textContent = stepContent[currentStep].subtitle;
        }

        // Actualizar botones
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        if (prevBtn) prevBtn.disabled = currentStep === 1;

        if (currentStep === totalSteps) {
            if (nextBtn) nextBtn.style.display = 'none';
            if (submitBtn) submitBtn.style.display = 'inline-flex';
            updateSummary();
        } else {
            if (nextBtn) nextBtn.style.display = 'inline-flex';
            if (submitBtn) submitBtn.style.display = 'none';
        }

        updatePreview();
    }

    // Actualizar resumen
    function updateSummary() {
        const form = document.getElementById('destinoForm');
        if (!form) return;
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        const provinciaSelect = document.getElementById('provincia');
        const distritoSelect = document.getElementById('distrito');
        const provinciaText = provinciaSelect ? provinciaSelect.selectedOptions[0]?.text || '' : '';
        const distritoText = distritoSelect ? distritoSelect.selectedOptions[0]?.text || '' : '';

        const hasImage = document.getElementById('imagen')?.files?.length > 0;

        const summaryHTML = `
            <div style="display: grid; gap: 15px;">
                <div><strong>Nombre:</strong> ${data.Nombre || 'No especificado'}</div>
                <div><strong>Ubicación:</strong> ${distritoText}, ${provinciaText}</div>
                <div><strong>Tipo:</strong> ${data.Tipo || 'No especificado'}</div>
                <div><strong>Descripción:</strong><br><span style="color:#666; font-style: italic;">${data.Descripcion || 'No especificada'}</span></div>
                <div><strong>Horario:</strong> ${data.Horario || 'No especificado'}</div>
                <div><strong>Estado:</strong> ${data.Descripcion_EST || 'No especificado'}</div>
                <div><strong>Precio de entrada:</strong> $${data.Precio_Entrada || '0.00'} USD</div>
                <div><strong>Ubicación del mapa:</strong> ${data.Ubicacion_Mapa_URL ? 'Enlace proporcionado' : 'No especificado'}</div>
                <div><strong>Imagen:</strong> ${hasImage ? 'Imagen cargada' : 'Sin imagen'}</div>
            </div>
        `;
        
        const summaryContainer = document.getElementById('summaryContent');
        if (summaryContainer) {
            summaryContainer.innerHTML = summaryHTML;
        }
    }

    // Actualizar preview en tiempo real
    function updatePreview() {
        const nombre = document.getElementById('nombre')?.value || '';
        const tipo = document.getElementById('tipo')?.value || '';
        const provinciaSelect = document.getElementById('provincia');
        const distritoSelect = document.getElementById('distrito');
        const provincia = provinciaSelect ? provinciaSelect.selectedOptions[0]?.text || '' : '';
        const distrito = distritoSelect ? distritoSelect.selectedOptions[0]?.text || '' : '';

        const destinationInfo = document.getElementById('destinationInfo');
        const destinationName = document.getElementById('destinationName');
        const destinationDetails = document.getElementById('destinationDetails');

        if (nombre && tipo && destinationInfo && destinationName && destinationDetails) {
            destinationName.textContent = nombre;
            destinationDetails.textContent = `${tipo} en ${distrito}, ${provincia}`;
            destinationInfo.classList.add('show');
        } else if (destinationInfo) {
            destinationInfo.classList.remove('show');
        }
    }

    // Validar todos los campos obligatorios
    function validateAllRequiredFields() {
        const fields = [
            { id: 'nombre', label: 'Nombre del lugar' },
            { id: 'descripcion', label: 'Descripción' },
            { id: 'provincia', label: 'Provincia' },
            { id: 'distrito', label: 'Distrito' },
            { id: 'mapa', label: 'URL del mapa' },
            { id: 'tipo', label: 'Tipo de destino' }
        ];

        const missingFields = [];

        fields.forEach(f => {
            const element = document.getElementById(f.id);
            if (!element || !element.value.trim()) {
                missingFields.push(f.label);
                if (element) element.classList.add('field-validation');
            } else {
                if (element) {
                    element.classList.remove('field-validation');
                    element.classList.add('field-valid');
                }
            }
        });

        if (missingFields.length > 0) {
            showErrorMessage('Faltan datos obligatorios: ' + missingFields.join(', '));
            return false;
        }
        return true;
    }

    // Manejar envío del formulario
    function handleSubmit(event) {
        event.preventDefault();

        if (!validateAllRequiredFields()) {
            return;
        }

        // Mostrar estado de envío
        const submitButton = document.getElementById('submitBtn');
        if (submitButton) {
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            submitButton.disabled = true;

            const formData = new FormData(event.target);

            fetch('/TourIstmo/BACKEND/formulario-destino.jsp', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                // Mostrar mensaje de éxito
                showSuccessMessage('¡Destino registrado exitosamente!');
                
                // Opcional: recargar página después de un delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            })
            .catch(error => {
                console.error('Error al enviar:', error);
                showErrorMessage('Error al enviar el formulario. Por favor, intenta nuevamente.');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        }
    }

    // Mostrar mensaje de éxito
    function showSuccessMessage(message) {
        const successContainer = document.getElementById('successMessage');
        if (successContainer) {
            successContainer.textContent = message;
            successContainer.style.display = 'block';
            successContainer.scrollIntoView({ behavior: 'smooth' });
        }
    }

    // Mostrar mensaje de error
    function showErrorMessage(message) {
        let errorContainer = document.getElementById('errorMessage');

        if (!errorContainer) {
            errorContainer = document.createElement('div');
            errorContainer.id = 'errorMessage';
            errorContainer.style.cssText = `
                background-color: #fef2f2;
                color: #dc2626;
                padding: 15px;
                border-radius: 8px;
                margin: 20px 0;
                border: 1px solid #fecaca;
                display: none;
                font-size: 14px;
            `;

            const form = document.getElementById('destinoForm');
            if (form && form.parentNode) {
                form.parentNode.insertBefore(errorContainer, form);
            }
        }

        errorContainer.textContent = message;
        errorContainer.style.display = 'block';
        errorContainer.scrollIntoView({ behavior: 'smooth' });

        setTimeout(() => {
            errorContainer.style.display = 'none';
        }, 5000);
    }
  </script>
</body>
</html>